## ğŸ‘‹ ä»‹ç»
MoviePilot æ¶ˆæ¯é€šçŸ¥æ‰©å±•æ’ä»¶ç”¨äºå¢å¼ºç³»ç»Ÿæ¶ˆæ¯é€šçŸ¥åŠŸèƒ½ï¼Œæ”¯æŒè‡ªå®šä¹‰æ¨¡æ¿å’Œåˆ†å‘è§„åˆ™ï¼Œå®ç°æ›´çµæ´»çš„æ¶ˆæ¯é€šçŸ¥ç®¡ç†ã€‚

## âœ¨ ç‰¹æ€§
- ğŸ”§ è‡ªå®šä¹‰æ¶ˆæ¯æ¨¡æ¿
- ğŸ“ çµæ´»çš„æ¶ˆæ¯åˆ†å‘è§„åˆ™
- ğŸ¯ æ”¯æŒæ­£åˆ™è¡¨è¾¾å¼åŒ¹é…
- â° æ¶ˆæ¯å†·å´æ—¶é—´æ§åˆ¶
- ğŸ“¦ æ¶ˆæ¯æ‰¹é‡èšåˆ
- ğŸ” å…ƒæ•°æ®æå–ä¸è¯†åˆ«

## âš™ï¸ é…ç½®è¯´æ˜

### åŸºç¡€é…ç½®
- `æ¶ˆæ¯å†·å´æ—¶é—´(åˆ†é’Ÿ)`: é˜²æ­¢çŸ­æ—¶é—´å†…é‡å¤å‘é€ç›¸åŒæ¶ˆæ¯.

### æ¶ˆæ¯æ¨¡æ¿
ä½¿ç”¨ä¸»ç¨‹åºç›¸åŒ`æ ¼å¼&è¯­æ³•`,
åœ¨`æ­£åˆ™åŒ¹é…`æ¨¡å¼ä¸‹æ”¯æŒè‡ªå®šä¹‰å­—æ®µçš„ä½¿ç”¨

### åˆ†å‘è§„åˆ™
åˆ†å‘è§„åˆ™å†³å®šæ¶ˆæ¯å¦‚ä½•è¢«å¤„ç†å’Œå‘é€ï¼š
> ç›®æ ‡æ¸ é“
> - æ¶ˆæ¯å‘å¾€ä½•å¤„

### ğŸŒ° æ­£åˆ™åŒ¹é…ä½¿ç”¨ç¤ºä¾‹

#### Extractors é…ç½®
ä½¿ç”¨ `extractors` å®šä¹‰éœ€è¦ä»æ¶ˆæ¯ä¸­æå–çš„ä¿¡æ¯:

```yaml
extractors:
  - field: 'title'  # åŒ¹é…æ¥æº: title(æ ‡é¢˜)ã€text(å†…å®¹)ã€link(é“¾æ¥)ã€image(å›¾ç‰‡)
    org_msg_title: '.*'  # å°†å®Œæ•´æ ‡é¢˜å­˜å‚¨åˆ° org_msg_title å˜é‡
  
  - field: 'text'
    torrent_name: 'ä½ ä¸‹è½½çš„ç§å­''(?P<torrent_name>.*?)''è¢«ç®¡ç†å‘˜åˆ é™¤'
    reason: 'åŸå› ï¼š(?P<reason>.*)'
```

#### æ­£åˆ™åŒ¹é…è§„åˆ™
æ”¯æŒä¸¤ç§æ•è·ç»„è¯­æ³•:

1. å‘½åæ•è·ç»„ `(?P<name>expression)`
```yaml
example: 'åŸå› ï¼š(?P<reason>.*)'  # å­˜å‚¨åˆ°å˜é‡ reason
# æ¨¡æ¿ä¸­ä½¿ç”¨: {% if reason %}{{ reason }}{% endif %}
```

2. æ™®é€šæ•è·ç»„ `(expression)`
```yaml
site_name: 'ã€ç«™ç‚¹\s+([^\s]+)\s+æ¶ˆæ¯ã€‘'  # å­˜å‚¨åˆ°å˜é‡ site_name
# æ¨¡æ¿ä¸­ä½¿ç”¨: {% if site_name %}{{ site_name }}{% endif %}
# æ³¨æ„: æ¯æ¡æ­£åˆ™ä»…æå–ç¬¬ä¸€ä¸ªåŒ¹é…ç»„
```

#### MetaBase é…ç½®
ç”¨äºå°†æå–çš„ä¿¡æ¯ç»‘å®šåˆ°åª’ä½“ä¿¡æ¯å¯¹è±¡:

```yaml
MetaBase:
  title: 'torrent_name'  # å°† torrent_name çš„åŒ¹é…ç»“æœç»‘å®šåˆ° title
  tmdbid: 'tmdb_id'     # å¯é€‰:ç»‘å®š tmdbid å®ç°ç²¾å‡†è¯†åˆ«
```

**æ³¨æ„äº‹é¡¹:**
- å¿…é¡»ç»‘å®š `title` æ‰èƒ½è·å–å®Œæ•´åª’ä½“ä¿¡æ¯
- æœªç»‘å®šæ—¶æ¨¡æ¿ä»…å¯ä½¿ç”¨ `extractors` æå–çš„å˜é‡
- æ›´å¤šæ”¯æŒçš„å±æ€§è¯·å‚è€ƒ [MetaInfo](https://github.com/jxxghp/MoviePilot/blob/fcd5ca3fda1992ece6bb2111afa1b75909d0557f/app/schemas/context.py#L6-L61)

### æ¶ˆæ¯èšåˆ
é€šè¿‡æ¶ˆæ¯èšåˆåŠŸèƒ½ï¼Œå¯ä»¥å°†åŒä¸€è§„åˆ™åŒ¹é…åˆ°çš„å¤šæ¡æ¶ˆæ¯åœ¨è®¾å®šæ—¶é—´åç»Ÿä¸€å‘é€ã€‚

#### é…ç½®æ–¹æ³•
åœ¨è§„åˆ™é…ç½®ä¸­æ·»åŠ  `Aggregate` æ®µè½ï¼š

```yaml
Aggregate:
  required: ['field1', 'field2']  # éœ€è¦åŒ¹é…çš„å¿…è¦å­—æ®µ
  send_in: 2  # å¯é€‰ï¼Œèšåˆç­‰å¾…æ—¶é—´(å°æ—¶)ï¼Œé»˜è®¤2å°æ—¶
```

- `required`: åˆ—è¡¨ç±»å‹ï¼ŒæŒ‡å®šéœ€è¦å®Œå…¨åŒ¹é…æ‰ä¼šè¢«åŠ å…¥èšåˆçš„å­—æ®µ
- `send_in`: æµ®ç‚¹ç±»å‹ï¼Œæ”¶é›†æ—¶é—´å†…ç¬¦åˆè§„åˆ™çš„æ¶ˆæ¯ï¼Œé»˜è®¤ä¸º2å°æ—¶

èšåˆæ¶ˆæ¯æ¨¡æ¿ä¸­å¯ä½¿ç”¨çš„ç‰¹æ®Šå˜é‡ï¼š
- `messages`: åˆ—è¡¨ç±»å‹ï¼ŒåŒ…å«æ‰€æœ‰`required`åŒ¹é…çš„æ¶ˆæ¯å†…å®¹
- `count`: æ•°å­—ç±»å‹ï¼Œæ¶ˆæ¯æ€»æ•°
- `first_time`: é¦–æ¡æ¶ˆæ¯æ—¶é—´
- `last_time`: æœ€åä¸€æ¡æ¶ˆæ¯æ—¶é—´

#### ä½¿ç”¨ç¤ºä¾‹
ä»¥`è§‚ä¼—` åˆ ç§çš„`ç«™ç‚¹æ¶ˆæ¯`ä¸ºä¾‹:

##### è§„åˆ™YAMLæ¨¡æ¿
```yaml
extractors:
  - field: 'title'
    site_name: 'ã€ç«™ç‚¹\s+([^\s]+)\s+æ¶ˆæ¯ã€‘' # æå–ç«™ç‚¹åç§°

  - field: 'text'
    audiences: |-
      æ ‡é¢˜ï¼š(?P<title>ç§å­è¢«åˆ é™¤)
      å†…å®¹ï¼š
      ä½ ä¸‹è½½çš„ç§å­'(?P<torrent_name>[^']+)'è¢«ç®¡ç†å‘˜åˆ é™¤ã€‚åŸå› ï¼š(?P<reason>.+ã€‚)

Aggregate: # æ¶ˆæ¯èšåˆå­˜åœ¨å³å¼€å¯
  required: ['site_name', 'title', 'torrent_name', 'reason'] # éœ€è¦åŒ¹é…å…¨éƒ¨å­—æ®µæ‰ä¼šåŠ å…¥æ¶ˆæ¯èšåˆ, å¯æŒ‰åœºæ™¯å¢åˆ 
  send_on: 0.1 # æ”¶é›†0.1å°æ—¶å†…æ‰€æœ‰åŒ¹é…çš„æ¶ˆæ¯
```
éœ€è¦å¢åŠ ç«™ç‚¹`åˆ ç§æ¶ˆæ¯` åªéœ€ç»­å†™`field: 'text'`
```yaml
...existing code...

  - field: 'text'
    audiences: |-
      æ ‡é¢˜ï¼š(?P<title>ç§å­è¢«åˆ é™¤)
      å†…å®¹ï¼š
      ä½ ä¸‹è½½çš„ç§å­'(?P<torrent_name>[^']+)'è¢«ç®¡ç†å‘˜åˆ é™¤ã€‚åŸå› ï¼š(?P<reason>.+ã€‚)

    xxxxx: |-
      æ ‡é¢˜...
      ...

...existing code...
```

##### æ¶ˆæ¯æ¸²æŸ“æ¨¡æ¿
```json
{
    "title": "ğŸ“¢ ç«™ç‚¹æ¶ˆæ¯é€šçŸ¥",
    "text": (
        "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n"
        "{%- set sites = {} -%}"
        "{%- for msg in messages -%}"
        "{%- if msg.site_name and msg.reason -%}"
        "{%- set _ = sites.update({msg.site_name: msg.reason}) -%}"
        "{%- endif -%}"
        "{%- endfor -%}"
        "{%- for site, reason in sites.items() %}\n"
        "*ğŸ”¹ ç«™ç‚¹ï¼š{{ site }}*\n"
        "ğŸ”¸ åŸå› ï¼š{{ reason }}\n"
        "{%- for msg in messages if msg.site_name == site %}\n"
        "â¤ *{{ msg.torrent_name }}*"
        "{%- endfor -%}"
        "\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        "{%- if not loop.last %}\n{% endif -%}"
        "{%- endfor -%}\n"
        "â° ç»Ÿè®¡æ—¶é—´ï¼š{{ last_time | truncate(16, True, '') }}"
    )
}
```

å¯ç”¨èšåˆåŠŸèƒ½åï¼Œæ’ä»¶ä¼šï¼š
1. æ”¶é›†æŒ‡å®šæ—¶é—´å†…ç¬¦åˆè§„åˆ™çš„æ¶ˆæ¯
2. åœ¨ç­‰å¾…æ—¶é—´ç»“æŸåç»Ÿä¸€å‘é€
3. å¦‚æœç¨‹åºé‡å¯ï¼Œè¶…æ—¶çš„æ¶ˆæ¯ä¼šåœ¨é‡å¯å5åˆ†é’Ÿåˆ†åˆ«å‘é€

## ğŸ“ æ³¨æ„äº‹é¡¹
1. æ­£åˆ™è¡¨è¾¾å¼è§„åˆ™è¯·ç¡®ä¿æ ¼å¼æ­£ç¡®
