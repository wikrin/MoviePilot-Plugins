import{importShared as e}from"./__federation_fn_import-D8XbxH1x.js";const l=[];for(let ie=0;ie<256;++ie)l.push((ie+256).toString(16).slice(1));let t;const a=new Uint8Array(16);const o={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function n(e,n,u){if(o.randomUUID&&!e)return o.randomUUID();const d=(e=e||{}).random??e.rng?.()??function(){if(!t){if("undefined"==typeof crypto||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");t=crypto.getRandomValues.bind(crypto)}return t(a)}();if(d.length<16)throw new Error("Random bytes length must be >= 16");return d[6]=15&d[6]|64,d[8]=63&d[8]|128,function(e,t=0){return(l[e[t+0]]+l[e[t+1]]+l[e[t+2]]+l[e[t+3]]+"-"+l[e[t+4]]+l[e[t+5]]+"-"+l[e[t+6]]+l[e[t+7]]+"-"+l[e[t+8]]+l[e[t+9]]+"-"+l[e[t+10]]+l[e[t+11]]+l[e[t+12]]+l[e[t+13]]+l[e[t+14]]+l[e[t+15]]).toLowerCase()}(d)}const{defineComponent:u}=await e("vue"),{toDisplayString:d,createElementVNode:i,resolveComponent:r,withModifiers:s,createVNode:c,withCtx:m,createTextVNode:v,vShow:p,withDirectives:f,openBlock:_,createBlock:y,createCommentVNode:g}=await e("vue"),{ref:b,watch:x}=await e("vue"),w=(e,l)=>{const t=e.__vccOpts||e;for(const[a,o]of l)t[a]=o;return t},V=w(u({__name:"RuleCard",props:{rule:{type:Object,required:!0},index:{type:Number,required:!0},sourceOptions:{type:Array,default:()=>[]},rules:{type:Array,required:!0},templates:{type:Array,default:()=>[]}},emits:["save","delete","alert"],setup(e,{emit:l}){const t=e,a=l,o=b(!1),n=b({...t.rule}),u=b(null),w=[{title:"资源入库",value:"organizeSuccess"},{title:"资源下载",value:"downloadAdded"},{title:"添加订阅",value:"subscribeAdded"},{title:"订阅完成",value:"subscribeComplete"},{title:"正则匹配",value:"regex"}];function V(){u.value=t.index,o.value=!0}function h(){n.value.name.trim()?(a("save",n.value,u.value),o.value=!1):a("alert","规则名称不能为空","error")}function C(){o.value=!1}return x((()=>n.value.media_type),(()=>{n.value.media_category=void 0})),x((()=>t.rule),(e=>{n.value={...e}})),x((()=>n.value.type),((e,l)=>{l&&(n.value.yaml_content="regex"===e&&"regex"!==l?"\n# extractors 中 除field外, 其余所有字段都将作为消息模板中的可用参数\n# MetaBase 如果需要获取媒体信息必须绑定title, 否则消息模板中的可用参数仅有extractors中匹配的字段\n# 详见: https://github.com/wikrin/MoviePilot-Plugins/blob/main/frontend/notifyext/README.md\nextractors:\n  - field: 'title'\n    org_msg_title: '.*'\n\nMetaBase:\n  - title: ''\n":"")}),{immediate:!0}),(l,a)=>{const u=r("v-btn"),b=r("v-card-title"),x=r("v-divider"),k=r("v-switch"),U=r("v-col"),N=r("v-select"),S=r("v-row"),E=r("v-text-field"),j=r("V-ace-editor"),A=r("v-card-text"),I=r("v-card"),D=r("v-form"),z=r("v-spacer"),B=r("v-card-actions"),$=r("v-dialog");return _(),y(I,{class:"rule-card rounded-lg",elevation:"2",onClick:V},{default:m((()=>[c(b,{class:"d-flex justify-space-between align-center py-2 px-3 bg-grey-lighten-3"},{default:m((()=>[i("span",null,d(e.rule.name),1),c(u,{icon:"mdi-delete",size:"x-small",color:"grey",onClick:a[0]||(a[0]=s((t=>l.$emit("delete",e.index)),["stop"]))})])),_:1}),c($,{modelValue:o.value,"onUpdate:modelValue":a[8]||(a[8]=e=>o.value=e),"max-width":"50rem",scrollable:""},{default:m((()=>[n.value?(_(),y(I,{key:0},{default:m((()=>[c(b,{class:"bg-primary-lighten-5"},{default:m((()=>[v("编辑规则 "+d(n.value.name),1)])),_:1}),c(x),c(A,{class:"py-4"},{default:m((()=>[c(D,{onSubmit:s(h,["prevent"])},{default:m((()=>[c(S,null,{default:m((()=>[c(U,{cols:"12",md:"6"},{default:m((()=>[c(k,{modelValue:n.value.enabled,"onUpdate:modelValue":a[1]||(a[1]=e=>n.value.enabled=e),label:"启用规则",inset:""},null,8,["modelValue"])])),_:1}),c(U,{cols:"12",md:"6"},{default:m((()=>[c(N,{modelValue:n.value.type,"onUpdate:modelValue":a[2]||(a[2]=e=>n.value.type=e),items:w,label:"规则类型",outlined:""},null,8,["modelValue"])])),_:1})])),_:1}),c(S,null,{default:m((()=>[c(U,{cols:"12",md:"6"},{default:m((()=>[c(E,{modelValue:n.value.name,"onUpdate:modelValue":a[3]||(a[3]=e=>n.value.name=e),label:"配置名",onInput:a[4]||(a[4]=e=>function(e){const l=e.name?.trim();if(!l)return;t.rules.filter((e=>e.name===l)).length>1?e.duplicateName=!0:delete e.duplicateName}(n.value)),required:"",outlined:""},null,8,["modelValue"])])),_:1}),c(U,{cols:"12",md:"6"},{default:m((()=>[c(N,{modelValue:n.value.target,"onUpdate:modelValue":a[5]||(a[5]=e=>n.value.target=e),items:e.sourceOptions,label:"目标渠道",clearable:"",outlined:""},null,8,["modelValue","items"])])),_:1})])),_:1}),c(S,null,{default:m((()=>[c(U,{cols:"12",md:"6"},{default:m((()=>[c(N,{modelValue:n.value.template_id,"onUpdate:modelValue":a[6]||(a[6]=e=>n.value.template_id=e),items:e.templates,label:"选择模板",clearable:"",outlined:""},null,8,["modelValue","items"])])),_:1})])),_:1}),f(c(I,null,{default:m((()=>[c(b,null,{default:m((()=>a[9]||(a[9]=[v("模板内容")]))),_:1,__:[9]}),c(A,{class:"py-0"},{default:m((()=>[c(j,{value:n.value.yaml_content,"onUpdate:value":a[7]||(a[7]=e=>n.value.yaml_content=e),lang:"yaml",class:"w-full h-full min-h-[30rem] rounded"},null,8,["value"])])),_:1})])),_:1},512),[[p,"regex"===n.value.type]])])),_:1})])),_:1}),c(x),c(B,null,{default:m((()=>[c(z),c(u,{color:"grey",onClick:C},{default:m((()=>a[10]||(a[10]=[v("取消")]))),_:1,__:[10]}),c(u,{color:"primary",onClick:h},{default:m((()=>a[11]||(a[11]=[v("保存")]))),_:1,__:[11]})])),_:1})])),_:1})):g("",!0)])),_:1},8,["modelValue"])])),_:1})}}}),[["__scopeId","data-v-c87fcd4d"]]),{defineComponent:h}=await e("vue"),{toDisplayString:C,createElementVNode:k,resolveComponent:U,withModifiers:N,createVNode:S,withCtx:E,createTextVNode:j,openBlock:A,createBlock:I,createCommentVNode:D}=await e("vue"),{ref:z,watch:B}=await e("vue"),$=w(h({__name:"TemplateCard",props:{template:{type:Object,required:!0},index:{type:Number,required:!0},templates:{type:Array,required:!0}},emits:["save","delete","alert"],setup(e,{emit:l}){const t=e,a=l,o=z(!1),n=z(),u=z(null);function d(){n.value={...t.template},u.value=t.index,o.value=!0}function i(){n.value.name.trim()?(a("save",n.value,u.value),o.value=!1):a("alert","模板名称不能为空","error")}function r(){o.value=!1}return B((()=>t.template),(e=>{n.value={...e}})),(l,t)=>{const a=U("v-btn"),u=U("v-card-title"),s=U("v-divider"),c=U("v-text-field"),m=U("v-col"),v=U("v-row"),p=U("V-ace-editor"),f=U("v-card-text"),_=U("v-card"),y=U("v-form"),g=U("v-spacer"),b=U("v-card-actions"),x=U("v-dialog");return A(),I(_,{class:"template-card rounded-lg",elevation:"2",onClick:d},{default:E((()=>[S(u,{class:"d-flex justify-space-between align-center py-2 px-3 bg-grey-lighten-3"},{default:E((()=>[k("span",null,C(e.template.name),1),S(a,{icon:"mdi-delete",size:"x-small",color:"grey",onClick:t[0]||(t[0]=N((t=>l.$emit("delete",e.index)),["stop"]))})])),_:1}),S(x,{modelValue:o.value,"onUpdate:modelValue":t[3]||(t[3]=e=>o.value=e),"max-width":"50rem",scrollable:""},{default:E((()=>[n.value?(A(),I(_,{key:0},{default:E((()=>[S(u,{class:"bg-primary-lighten-5"},{default:E((()=>[j("编辑模板 "+C(n.value.name),1)])),_:1}),S(s),S(f,{class:"py-4"},{default:E((()=>[S(y,{onSubmit:N(i,["prevent"])},{default:E((()=>[S(v,{dense:""},{default:E((()=>[S(m,{cols:"12"},{default:E((()=>[S(c,{modelValue:n.value.name,"onUpdate:modelValue":t[1]||(t[1]=e=>n.value.name=e),label:"模板名称",required:"",dense:"",outlined:""},null,8,["modelValue"])])),_:1})])),_:1}),S(_,null,{default:E((()=>[S(u,null,{default:E((()=>t[4]||(t[4]=[j("模板内容")]))),_:1,__:[4]}),S(f,{class:"py-0"},{default:E((()=>[S(p,{value:n.value.template,"onUpdate:value":t[2]||(t[2]=e=>n.value.template=e),lang:"json",class:"w-full h-full min-h-[30rem] rounded"},null,8,["value"])])),_:1})])),_:1})])),_:1})])),_:1}),S(s),S(b,null,{default:E((()=>[S(g),S(a,{color:"grey",onClick:r},{default:E((()=>t[5]||(t[5]=[j("取消")]))),_:1,__:[5]}),S(a,{color:"primary",onClick:i},{default:E((()=>t[6]||(t[6]=[j("保存")]))),_:1,__:[6]})])),_:1})])),_:1})):D("",!0)])),_:1},8,["modelValue"])])),_:1})}}}),[["__scopeId","data-v-7185c571"]]),{defineComponent:q}=await e("vue"),{resolveComponent:M,createVNode:O,createElementVNode:R,withCtx:T,toDisplayString:P,createTextVNode:F,openBlock:L,createBlock:G,createCommentVNode:H,renderList:J,Fragment:K,createElementBlock:Q,withModifiers:W}=await e("vue"),X={class:"plugin-config"},Y={class:"setting-item d-flex align-center justify-space-between pa-3 bg-grey-lighten-3 rounded"},Z={class:"d-flex align-center"},ee={class:"setting-item d-flex align-center justify-space-between pa-3 bg-grey-lighten-3 rounded"},le={class:"rules-tab"},te={class:"templates-tab"},{ref:ae,reactive:oe,onMounted:ne,computed:ue}=await e("vue"),de=w(q({__name:"Config",props:{api:{type:Object,required:!0},initialConfig:{type:Object,default:()=>({})}},emits:["close","save"],setup(e,{emit:l}){const t=e,a=l,o=oe({enabled:!1,cooldown:0}),u=oe({...o}),d=ae([]),i=ae([]),r=ae(!1),s=ae("");let c;const m=ae("rules"),v=ae(!0),p=ae(null),f=ae(null),_=ae(null),y=ae(!1),g=ae([]);const b=oe({show:!1,text:"",color:"success",timeout:3e3});function x(e,l="success"){b.text=e,b.color=l,b.show=!0}function w(){r.value=!1,c(!0)}function h(){r.value=!1,c(!1)}const C=ue((()=>[{title:"跟随系统",value:""},...g.value.map((e=>({title:`${e.name}-${e.type}`,value:e.name})))])),k=ue((()=>i.value.map((e=>({title:e.name,value:e.id})))));function U(){return n()}function N(){let e=`规则${d.value.length+1}`;for(;d.value.some((l=>l.name===e));)e=`规则${parseInt(e.split("规则")[1])+1}`;d.value.push({id:U(),name:e,enabled:!1,type:"organizeSuccess",target:""})}function S(e,l){null===l?d.value.push(e):d.value[l]=e}function E(e){d.value.splice(e,1)}function j(){let e=`模板${i.value.length+1}`;for(;i.value.some((l=>l.name===e));)e=`模板${parseInt(e.split("模板")[1])+1}`;i.value.push({id:U(),name:e,template:"{\n  'title': '',\n  'text': ''\n}"})}function A(e,l){null===l?i.value.push(e):i.value[l]=e}async function I(e){const l=i.value[e],t=d.value.filter((e=>["organizeSuccess","downloadAdded","subscribeAdded","subscribeComplete"].some((t=>e[t]===l.id))));if(t.length>0){if(!(await(a=`该模板正在以下 ${t.length} 条规则中被引用：\n${t.map((e=>e.name)).join(", ")}\n\n确定要删除吗？`,s.value=a,r.value=!0,new Promise((e=>{c=e})))))return}var a;d.value.forEach(((e,t)=>{const a=["organizeSuccess","downloadAdded","subscribeAdded","subscribeComplete"].find((t=>e[t]===l.id));a&&(d.value[t]={...e,[a]:void 0})})),i.value.splice(e,1)}async function D(){y.value=!0,f.value=null;try{await async function(){try{await t.api.post("plugin/NotifyExt/rules",d.value),_.value="规则保存成功"}catch(e){console.log(e)}}(),await async function(){try{await t.api.post("plugin/NotifyExt/templates",i.value),_.value="模板保存成功"}catch(e){console.log(e)}}(),a("save",{...u}),_.value="配置保存成功"}catch(e){console.error("保存配置失败:",e),f.value=e.message||"保存配置失败"}finally{y.value=!1}}function z(){Object.keys(o).forEach((e=>{u[e]=o[e]})),p.value&&p.value.resetValidation()}return ne((()=>{t.initialConfig&&Object.keys(t.initialConfig).forEach((e=>{e in u&&(u[e]=t.initialConfig[e])})),async function(){try{const e=await t.api.get("system/setting/Notifications");g.value=e.data?.value??[]}catch(e){console.log(e)}}(),async function(){try{const e=await t.api.get("plugin/NotifyExt/templates");i.value=e??[]}catch(e){console.log(e)}}(),async function(){try{const e=await t.api.get("plugin/NotifyExt/rules");d.value=e??[]}catch(e){console.log(e)}}()})),(e,l)=>{const t=M("v-icon"),o=M("v-card-title"),n=M("v-alert"),c=M("v-switch"),g=M("v-col"),U=M("v-text-field"),B=M("v-row"),q=M("v-card-text"),ae=M("v-card"),oe=M("v-tab"),ne=M("v-tabs"),ue=M("VIcon"),de=M("VBtn"),ie=M("VBtnGroup"),re=M("VForm"),se=M("VCardText"),ce=M("v-window-item"),me=M("v-window"),ve=M("v-form"),pe=M("v-spacer"),fe=M("v-btn"),_e=M("v-card-actions"),ye=M("v-dialog"),ge=M("v-snackbar");return L(),Q("div",X,[O(ae,{flat:"",class:"rounded border"},{default:T((()=>[O(o,{class:"text-subtitle-1 d-flex align-center px-3 py-2 bg-primary-lighten-5"},{default:T((()=>[O(t,{icon:"mdi-cog",class:"mr-2",color:"primary",size:"small"}),l[10]||(l[10]=R("span",null,"消息通知扩展配置",-1))])),_:1,__:[10]}),O(q,{class:"px-3 py-2"},{default:T((()=>[f.value?(L(),G(n,{key:0,type:"error",density:"compact",class:"mb-2 text-caption",variant:"tonal",closable:""},{default:T((()=>[F(P(f.value),1)])),_:1})):H("",!0),_.value?(L(),G(n,{key:1,type:"success",density:"compact",class:"mb-2 text-caption",variant:"tonal",closable:""},{default:T((()=>[F(P(_.value),1)])),_:1})):H("",!0),O(ve,{ref_key:"form",ref:p,modelValue:v.value,"onUpdate:modelValue":l[5]||(l[5]=e=>v.value=e),onSubmit:W(D,["prevent"])},{default:T((()=>[O(ae,{flat:"",class:"rounded mb-3 border config-card"},{default:T((()=>[O(q,{class:"px-3 py-2"},{default:T((()=>[O(B,{dense:"","no-gutters":""},{default:T((()=>[O(g,{cols:"12",md:"6",class:"pr-md-2 pb-2"},{default:T((()=>[R("div",Y,[R("div",Z,[O(t,{icon:"mdi-power",size:"small",color:u.enabled?"info":"grey",class:"mr-3"},null,8,["color"]),l[11]||(l[11]=R("span",{class:"text-subtitle-2"},"启用插件",-1))]),O(c,{modelValue:u.enabled,"onUpdate:modelValue":l[0]||(l[0]=e=>u.enabled=e),color:"info",inset:"",density:"compact","hide-details":"",class:"small-switch"},null,8,["modelValue"])])])),_:1}),O(g,{cols:"12",md:"6",class:"pl-md-2 pb-2"},{default:T((()=>[R("div",ee,[l[12]||(l[12]=R("div",{class:"d-flex align-center"},[R("span",{class:"text-subtitle-2"},"重复消息控制(分钟)")],-1)),O(U,{modelValue:u.cooldown,"onUpdate:modelValue":l[1]||(l[1]=e=>u.cooldown=e),modelModifiers:{number:!0},density:"compact","hide-details":"",style:{"max-width":"150px"},onInput:l[2]||(l[2]=e=>u.cooldown=e.replace(/[^0-9]/g,""))},null,8,["modelValue"])])])),_:1})])),_:1})])),_:1})])),_:1}),O(ae,{flat:"",class:"rounded mb-3 border config-card"},{default:T((()=>[O(q,{class:"px-3 py-2"},{default:T((()=>[O(ne,{modelValue:m.value,"onUpdate:modelValue":l[3]||(l[3]=e=>m.value=e),class:"mb-3",density:"compact","fixed-tabs":""},{default:T((()=>[O(oe,{value:"rules"},{default:T((()=>l[13]||(l[13]=[F("消息规则")]))),_:1,__:[13]}),O(oe,{value:"templates"},{default:T((()=>l[14]||(l[14]=[F("消息模板")]))),_:1,__:[14]})])),_:1},8,["modelValue"]),O(me,{modelValue:m.value,"onUpdate:modelValue":l[4]||(l[4]=e=>m.value=e)},{default:T((()=>[O(ce,{value:"rules"},{default:T((()=>[R("div",le,[d.value&&d.value.length>0?(L(),G(B,{key:0},{default:T((()=>[(L(!0),Q(K,null,J(d.value,((e,l)=>(L(),G(g,{key:e.id,cols:"12",md:"6",lg:"4"},{default:T((()=>[O(V,{rule:e,index:l,"source-options":C.value,rules:d.value,templates:k.value,onAlert:x,onSave:S,onDelete:E},null,8,["rule","index","source-options","rules","templates"])])),_:2},1024)))),128))])),_:1})):(L(),G(B,{key:1},{default:T((()=>[O(g,{cols:"12"},{default:T((()=>[O(n,{type:"info",variant:"tonal",icon:"mdi-information"},{default:T((()=>l[15]||(l[15]=[F(" 暂无规则，请点击下方按钮添加新规则 ")]))),_:1,__:[15]})])),_:1})])),_:1})),O(se,null,{default:T((()=>[O(re,{onSubmit:W((()=>{}),["prevent"])},{default:T((()=>[O(ie,{density:"comfortable",class:"d-flex flex-wrap gap-4 mt-4"},{default:T((()=>[O(de,{color:"success",variant:"tonal",onClick:N},{default:T((()=>[O(ue,{icon:"mdi-plus"})])),_:1})])),_:1})])),_:1})])),_:1})])])),_:1}),O(ce,{value:"templates"},{default:T((()=>[R("div",te,[i.value&&i.value.length>0?(L(),G(B,{key:0},{default:T((()=>[(L(!0),Q(K,null,J(i.value,((e,l)=>(L(),G(g,{key:e.id,cols:"12",md:"6",lg:"4"},{default:T((()=>[O($,{template:e,index:l,templates:i.value,onAlert:x,onSave:A,onDelete:I},null,8,["template","index","templates"])])),_:2},1024)))),128))])),_:1})):(L(),G(B,{key:1},{default:T((()=>[O(g,{cols:"12"},{default:T((()=>[O(n,{type:"info",variant:"tonal",icon:"mdi-information"},{default:T((()=>l[16]||(l[16]=[F(" 暂无消息模板，请点击下方按钮添加新模板 ")]))),_:1,__:[16]})])),_:1})])),_:1})),O(se,null,{default:T((()=>[O(re,{onSubmit:W((()=>{}),["prevent"])},{default:T((()=>[O(ie,{density:"comfortable",class:"d-flex flex-wrap gap-4 mt-4"},{default:T((()=>[O(de,{color:"success",variant:"tonal",onClick:j},{default:T((()=>[O(ue,{icon:"mdi-plus"})])),_:1})])),_:1})])),_:1})])),_:1})])])),_:1})])),_:1},8,["modelValue"])])),_:1})])),_:1})])),_:1},8,["modelValue"])])),_:1}),O(ye,{modelValue:r.value,"onUpdate:modelValue":l[6]||(l[6]=e=>r.value=e),"max-width":"400"},{default:T((()=>[O(ae,null,{default:T((()=>[O(o,{class:"text-h6"},{default:T((()=>l[17]||(l[17]=[F("确认操作")]))),_:1,__:[17]}),O(q,null,{default:T((()=>[F(P(s.value),1)])),_:1}),O(_e,null,{default:T((()=>[O(pe),O(fe,{color:"grey",text:"",onClick:h},{default:T((()=>l[18]||(l[18]=[F("取消")]))),_:1,__:[18]}),O(fe,{color:"primary",onClick:w},{default:T((()=>l[19]||(l[19]=[F("确定")]))),_:1,__:[19]})])),_:1})])),_:1})])),_:1},8,["modelValue"]),O(ge,{modelValue:b.show,"onUpdate:modelValue":l[8]||(l[8]=e=>b.show=e),color:b.color,timeout:b.timeout},{actions:T((()=>[O(fe,{variant:"text",onClick:l[7]||(l[7]=e=>b.show=!1)},{default:T((()=>l[20]||(l[20]=[F(" 关闭 ")]))),_:1,__:[20]})])),default:T((()=>[F(P(b.text)+" ",1)])),_:1},8,["modelValue","color","timeout"]),O(_e,{class:"px-2 py-1"},{default:T((()=>[O(pe),O(fe,{color:"secondary",variant:"text",onClick:z,"prepend-icon":"mdi-restore",size:"small"},{default:T((()=>l[21]||(l[21]=[F("恢复默认")]))),_:1,__:[21]}),O(fe,{color:"primary",disabled:!v.value||y.value,onClick:D,loading:y.value,"prepend-icon":"mdi-content-save",variant:"text",size:"small"},{default:T((()=>l[22]||(l[22]=[F("保存配置")]))),_:1,__:[22]},8,["disabled","loading"]),O(fe,{color:"grey",onClick:l[9]||(l[9]=e=>a("close")),"prepend-icon":"mdi-close",variant:"text",size:"small"},{default:T((()=>l[23]||(l[23]=[F("关闭")]))),_:1,__:[23]})])),_:1})])),_:1})])}}}),[["__scopeId","data-v-d20c103e"]]);export{de as default};
