import{importShared as e}from"./__federation_fn_import-D8XbxH1x.js";const l=[];for(let de=0;de<256;++de)l.push((de+256).toString(16).slice(1));let a;const t=new Uint8Array(16);const o={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function u(e,u,n){if(o.randomUUID&&!e)return o.randomUUID();const d=(e=e||{}).random??e.rng?.()??function(){if(!a){if("undefined"==typeof crypto||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");a=crypto.getRandomValues.bind(crypto)}return a(t)}();if(d.length<16)throw new Error("Random bytes length must be >= 16");return d[6]=15&d[6]|64,d[8]=63&d[8]|128,function(e,a=0){return(l[e[a+0]]+l[e[a+1]]+l[e[a+2]]+l[e[a+3]]+"-"+l[e[a+4]]+l[e[a+5]]+"-"+l[e[a+6]]+l[e[a+7]]+"-"+l[e[a+8]]+l[e[a+9]]+"-"+l[e[a+10]]+l[e[a+11]]+l[e[a+12]]+l[e[a+13]]+l[e[a+14]]+l[e[a+15]]).toLowerCase()}(d)}const{defineComponent:n}=await e("vue"),{toDisplayString:d,createElementVNode:i,resolveComponent:s,withModifiers:r,createVNode:c,withCtx:m,createTextVNode:p,openBlock:v,createBlock:f,createCommentVNode:y}=await e("vue"),{computed:_,ref:g,watch:b}=await e("vue"),V=(e,l)=>{const a=e.__vccOpts||e;for(const[t,o]of l)a[t]=o;return a},x=V(n({__name:"RuleCard",props:{rule:{type:Object,required:!0},index:{type:Number,required:!0},sourceOptions:{type:Array,default:()=>[]},categories:{type:Object,default:()=>{}},rules:{type:Array,required:!0},templates:{type:Array,default:()=>[]}},emits:["save","delete","alert"],setup(e,{emit:l}){const a=e,t=l,o=g(!1),u=g({...a.rule}),n=g(null),V=[{title:"全部",value:""},{title:"电影",value:"电影"},{title:"电视剧",value:"电视剧"}];function x(){n.value=a.index,o.value=!0}const w=_((()=>{const e=[];return a.categories&&a.categories[u.value.media_type??""]?e.concat(a.categories[u.value.media_type??""]):e}));function h(){u.value.name.trim()?u.value.target?(t("save",u.value,n.value),o.value=!1):t("alert","未设置消息渠道","error"):t("alert","规则名称不能为空","error")}function C(){o.value=!1}return b((()=>u.value.media_type),(()=>{u.value.media_category=void 0})),b((()=>a.rule),(e=>{u.value={...e}})),(l,t)=>{const n=s("v-btn"),_=s("v-card-title"),g=s("v-divider"),b=s("v-switch"),k=s("v-col"),U=s("v-row"),N=s("v-text-field"),S=s("v-select"),A=s("v-combobox"),j=s("v-form"),E=s("v-card-text"),I=s("v-spacer"),z=s("v-card-actions"),D=s("v-card"),O=s("v-dialog");return v(),f(D,{class:"rule-card rounded-lg",elevation:"2",onClick:x},{default:m((()=>[c(_,{class:"d-flex justify-space-between align-center py-2 px-3 bg-grey-lighten-3"},{default:m((()=>[i("span",null,d(e.rule.name),1),c(n,{icon:"mdi-delete",size:"x-small",color:"grey",onClick:t[0]||(t[0]=r((a=>l.$emit("delete",e.index)),["stop"]))})])),_:1}),c(O,{modelValue:o.value,"onUpdate:modelValue":t[11]||(t[11]=e=>o.value=e),"max-width":"50rem",scrollable:""},{default:m((()=>[u.value?(v(),f(D,{key:0},{default:m((()=>[c(_,{class:"bg-primary-lighten-5"},{default:m((()=>[p("编辑规则 "+d(u.value.name),1)])),_:1}),c(g),c(E,{class:"py-4"},{default:m((()=>[c(j,{onSubmit:r(h,["prevent"])},{default:m((()=>[c(U,null,{default:m((()=>[c(k,{cols:"12",md:"6"},{default:m((()=>[c(b,{modelValue:u.value.enabled,"onUpdate:modelValue":t[1]||(t[1]=e=>u.value.enabled=e),label:"启用规则",inset:""},null,8,["modelValue"])])),_:1})])),_:1}),c(U,null,{default:m((()=>[c(k,{cols:"12",md:"6"},{default:m((()=>[c(N,{modelValue:u.value.name,"onUpdate:modelValue":t[2]||(t[2]=e=>u.value.name=e),label:"配置名",onInput:t[3]||(t[3]=e=>function(e){const l=e.name?.trim();if(!l)return;a.rules.filter((e=>e.name===l)).length>1?e.duplicateName=!0:delete e.duplicateName}(u.value)),required:"",outlined:""},null,8,["modelValue"])])),_:1}),c(k,{cols:"12",md:"6"},{default:m((()=>[c(S,{modelValue:u.value.target,"onUpdate:modelValue":t[4]||(t[4]=e=>u.value.target=e),items:e.sourceOptions,label:"目标渠道",clearable:"",outlined:""},null,8,["modelValue","items"])])),_:1})])),_:1}),c(U,null,{default:m((()=>[c(k,{cols:"12",md:"6"},{default:m((()=>[c(S,{modelValue:u.value.media_type,"onUpdate:modelValue":t[5]||(t[5]=e=>u.value.media_type=e),items:V,label:"媒体类型",clearable:"",outlined:""},null,8,["modelValue"])])),_:1}),u.value.media_type?(v(),f(k,{key:0,cols:"12",md:"6"},{default:m((()=>[c(A,{modelValue:u.value.media_category,"onUpdate:modelValue":t[6]||(t[6]=e=>u.value.media_category=e),items:w.value,label:"媒体类别",multiple:"",chips:"","deletable-chips":"",clearable:"",outlined:""},null,8,["modelValue","items"])])),_:1})):y("",!0)])),_:1}),c(U,null,{default:m((()=>[c(k,{cols:"12",md:"6"},{default:m((()=>[c(S,{modelValue:u.value.organizeSuccess,"onUpdate:modelValue":t[7]||(t[7]=e=>u.value.organizeSuccess=e),items:e.templates,label:"入库成功模板",clearable:"",outlined:""},null,8,["modelValue","items"])])),_:1}),c(k,{cols:"12",md:"6"},{default:m((()=>[c(S,{modelValue:u.value.downloadAdded,"onUpdate:modelValue":t[8]||(t[8]=e=>u.value.downloadAdded=e),items:e.templates,label:"下载添加模板",clearable:"",outlined:""},null,8,["modelValue","items"])])),_:1})])),_:1}),c(U,null,{default:m((()=>[c(k,{cols:"12",md:"6"},{default:m((()=>[c(S,{modelValue:u.value.subscribeAdded,"onUpdate:modelValue":t[9]||(t[9]=e=>u.value.subscribeAdded=e),items:e.templates,label:"订阅添加模板",clearable:"",outlined:""},null,8,["modelValue","items"])])),_:1}),c(k,{cols:"12",md:"6"},{default:m((()=>[c(S,{modelValue:u.value.subscribeComplete,"onUpdate:modelValue":t[10]||(t[10]=e=>u.value.subscribeComplete=e),items:e.templates,label:"订阅完成模板",clearable:"",outlined:""},null,8,["modelValue","items"])])),_:1})])),_:1})])),_:1})])),_:1}),c(g),c(z,null,{default:m((()=>[c(I),c(n,{color:"grey",onClick:C},{default:m((()=>t[12]||(t[12]=[p("取消")]))),_:1}),c(n,{color:"primary",onClick:h},{default:m((()=>t[13]||(t[13]=[p("保存")]))),_:1})])),_:1})])),_:1})):y("",!0)])),_:1},8,["modelValue"])])),_:1})}}}),[["__scopeId","data-v-116c60f1"]]),{defineComponent:w}=await e("vue"),{toDisplayString:h,createElementVNode:C,resolveComponent:k,withModifiers:U,createVNode:N,withCtx:S,createTextVNode:A,openBlock:j,createBlock:E,createCommentVNode:I}=await e("vue"),{ref:z,watch:D}=await e("vue"),O=V(w({__name:"TemplateCard",props:{template:{type:Object,required:!0},index:{type:Number,required:!0},templates:{type:Array,required:!0}},emits:["save","delete","alert"],setup(e,{emit:l}){const a=e,t=l,o=z(!1),u=z(),n=z(null);function d(){u.value={...a.template},n.value=a.index,o.value=!0}function i(){u.value.name.trim()?(t("save",u.value,n.value),o.value=!1):t("alert","模板名称不能为空","error")}function s(){o.value=!1}return D((()=>a.template),(e=>{u.value={...e}})),(l,a)=>{const t=k("v-btn"),n=k("v-card-title"),r=k("v-divider"),c=k("v-text-field"),m=k("v-col"),p=k("v-textarea"),v=k("v-row"),f=k("v-form"),y=k("v-card-text"),_=k("v-spacer"),g=k("v-card-actions"),b=k("v-card"),V=k("v-dialog");return j(),E(b,{class:"template-card rounded-lg",elevation:"2",onClick:d},{default:S((()=>[N(n,{class:"d-flex justify-space-between align-center py-2 px-3 bg-grey-lighten-3"},{default:S((()=>[C("span",null,h(e.template.name),1),N(t,{icon:"mdi-delete",size:"x-small",color:"grey",onClick:a[0]||(a[0]=U((a=>l.$emit("delete",e.index)),["stop"]))})])),_:1}),N(V,{modelValue:o.value,"onUpdate:modelValue":a[3]||(a[3]=e=>o.value=e),"max-width":"50rem",scrollable:""},{default:S((()=>[u.value?(j(),E(b,{key:0},{default:S((()=>[N(n,{class:"bg-primary-lighten-5"},{default:S((()=>[A("编辑模板 "+h(u.value.name),1)])),_:1}),N(r),N(y,{class:"py-4"},{default:S((()=>[N(f,{onSubmit:U(i,["prevent"])},{default:S((()=>[N(v,{dense:""},{default:S((()=>[N(m,{cols:"12"},{default:S((()=>[N(c,{modelValue:u.value.name,"onUpdate:modelValue":a[1]||(a[1]=e=>u.value.name=e),label:"模板名称",required:"",dense:"",outlined:""},null,8,["modelValue"])])),_:1}),N(m,{cols:"12"},{default:S((()=>[N(p,{modelValue:u.value.template,"onUpdate:modelValue":a[2]||(a[2]=e=>u.value.template=e),label:"模板内容",rows:"8","auto-grow":"",spellcheck:"false","persistent-hint":"",dense:"",outlined:""},null,8,["modelValue"])])),_:1})])),_:1})])),_:1})])),_:1}),N(r),N(g,null,{default:S((()=>[N(_),N(t,{color:"grey",onClick:s},{default:S((()=>a[4]||(a[4]=[A("取消")]))),_:1}),N(t,{color:"primary",onClick:i},{default:S((()=>a[5]||(a[5]=[A("保存")]))),_:1})])),_:1})])),_:1})):I("",!0)])),_:1},8,["modelValue"])])),_:1})}}}),[["__scopeId","data-v-5c4d08f5"]]),{defineComponent:$}=await e("vue"),{resolveComponent:q,createVNode:B,createElementVNode:M,withCtx:R,toDisplayString:T,createTextVNode:F,openBlock:L,createBlock:G,createCommentVNode:P,renderList:H,Fragment:J,createElementBlock:K,withModifiers:Q}=await e("vue"),W={class:"plugin-config"},X={class:"setting-item d-flex align-center justify-space-between pa-3 bg-grey-lighten-3 rounded"},Y={class:"d-flex align-center"},Z={class:"setting-item d-flex align-center justify-space-between pa-3 bg-grey-lighten-3 rounded"},ee={class:"rules-tab"},le={class:"templates-tab"},{ref:ae,reactive:te,onMounted:oe,computed:ue}=await e("vue"),ne=V($({__name:"Config",props:{api:{type:Object,required:!0},initialConfig:{type:Object,default:()=>({})}},emits:["close","save"],setup(e,{emit:l}){const a=e,t=l,o=te({enabled:!1,cooldown:0}),n=te({...o}),d=ae([]),i=ae([]),s=ae(!1),r=ae("");let c;const m=ae("rules"),p=ae(!0),v=ae(null),f=ae(null),y=ae(null),_=ae(!1),g=ae([]);const b=te({show:!1,text:"",color:"success",timeout:3e3});function V(e,l="success"){b.text=e,b.color=l,b.show=!0}function w(){s.value=!1,c(!0)}function h(){s.value=!1,c(!1)}const C=ue((()=>g.value.map((e=>({title:`${e.name}-${e.type}`,value:e.name}))))),k=ue((()=>i.value.map((e=>({title:e.name,value:e.id}))))),U=ae({});function N(){return u()}function S(){let e=`规则${d.value.length+1}`;for(;d.value.some((l=>l.name===e));)e=`规则${parseInt(e.split("规则")[1])+1}`;d.value.push({id:N(),name:e,enabled:!1,target:"",media_type:"",media_category:[]})}function A(e,l){null===l?d.value.push(e):d.value[l]=e}function j(e){d.value.splice(e,1)}function E(){let e=`模板${i.value.length+1}`;for(;i.value.some((l=>l.name===e));)e=`模板${parseInt(e.split("模板")[1])+1}`;i.value.push({id:N(),name:e,template:"{\n  'title': '',\n  'text': ''\n}"})}function I(e,l){null===l?i.value.push(e):i.value[l]=e}async function z(e){const l=i.value[e],a=d.value.filter((e=>["organizeSuccess","downloadAdded","subscribeAdded","subscribeComplete"].some((a=>e[a]===l.id))));if(a.length>0){if(!(await(t=`该模板正在以下 ${a.length} 条规则中被引用：\n${a.map((e=>e.name)).join(", ")}\n\n确定要删除吗？`,r.value=t,s.value=!0,new Promise((e=>{c=e})))))return}var t;d.value.forEach(((e,a)=>{const t=["organizeSuccess","downloadAdded","subscribeAdded","subscribeComplete"].find((a=>e[a]===l.id));t&&(d.value[a]={...e,[t]:void 0})})),i.value.splice(e,1)}async function D(){_.value=!0,f.value=null;try{await async function(){try{await a.api.post("plugin/NotifyExt/rules",d.value),y.value="规则保存成功"}catch(e){console.log(e)}}(),await async function(){try{await a.api.post("plugin/NotifyExt/templates",i.value),y.value="模板保存成功"}catch(e){console.log(e)}}(),t("save",{...n}),y.value="配置保存成功"}catch(e){console.error("保存配置失败:",e),f.value=e.message||"保存配置失败"}finally{_.value=!1}}function $(){Object.keys(o).forEach((e=>{n[e]=o[e]})),v.value&&v.value.resetValidation()}return oe((()=>{a.initialConfig&&Object.keys(a.initialConfig).forEach((e=>{e in n&&(n[e]=a.initialConfig[e])})),async function(){try{const e=await a.api.get("system/setting/Notifications");g.value=e.data?.value??[]}catch(e){console.log(e)}}(),async function(){try{U.value=await a.api.get("media/category")}catch(e){console.log(e)}}(),async function(){try{const e=await a.api.get("plugin/NotifyExt/templates");i.value=e??[]}catch(e){console.log(e)}}(),async function(){try{const e=await a.api.get("plugin/NotifyExt/rules");d.value=e??[]}catch(e){console.log(e)}}()})),(e,l)=>{const a=q("v-icon"),o=q("v-card-title"),u=q("v-alert"),c=q("v-switch"),g=q("v-col"),N=q("v-text-field"),ae=q("v-row"),te=q("v-card-text"),oe=q("v-card"),ue=q("v-tab"),ne=q("v-tabs"),de=q("VIcon"),ie=q("VBtn"),se=q("VBtnGroup"),re=q("VForm"),ce=q("VCardText"),me=q("v-window-item"),pe=q("v-window"),ve=q("v-form"),fe=q("v-spacer"),ye=q("v-btn"),_e=q("v-card-actions"),ge=q("v-dialog"),be=q("v-snackbar");return L(),K("div",W,[B(oe,{flat:"",class:"rounded border"},{default:R((()=>[B(o,{class:"text-subtitle-1 d-flex align-center px-3 py-2 bg-primary-lighten-5"},{default:R((()=>[B(a,{icon:"mdi-cog",class:"mr-2",color:"primary",size:"small"}),l[10]||(l[10]=M("span",null,"消息通知扩展配置",-1))])),_:1}),B(te,{class:"px-3 py-2"},{default:R((()=>[f.value?(L(),G(u,{key:0,type:"error",density:"compact",class:"mb-2 text-caption",variant:"tonal",closable:""},{default:R((()=>[F(T(f.value),1)])),_:1})):P("",!0),y.value?(L(),G(u,{key:1,type:"success",density:"compact",class:"mb-2 text-caption",variant:"tonal",closable:""},{default:R((()=>[F(T(y.value),1)])),_:1})):P("",!0),B(ve,{ref_key:"form",ref:v,modelValue:p.value,"onUpdate:modelValue":l[5]||(l[5]=e=>p.value=e),onSubmit:Q(D,["prevent"])},{default:R((()=>[B(oe,{flat:"",class:"rounded mb-3 border config-card"},{default:R((()=>[B(te,{class:"px-3 py-2"},{default:R((()=>[B(ae,{dense:"","no-gutters":""},{default:R((()=>[B(g,{cols:"12",md:"6",class:"pr-md-2 pb-2"},{default:R((()=>[M("div",X,[M("div",Y,[B(a,{icon:"mdi-power",size:"small",color:n.enabled?"info":"grey",class:"mr-3"},null,8,["color"]),l[11]||(l[11]=M("span",{class:"text-subtitle-2"},"启用插件",-1))]),B(c,{modelValue:n.enabled,"onUpdate:modelValue":l[0]||(l[0]=e=>n.enabled=e),color:"info",inset:"",density:"compact","hide-details":"",class:"small-switch"},null,8,["modelValue"])])])),_:1}),B(g,{cols:"12",md:"6",class:"pl-md-2 pb-2"},{default:R((()=>[M("div",Z,[l[12]||(l[12]=M("div",{class:"d-flex align-center"},[M("span",{class:"text-subtitle-2"},"重复消息控制(分钟)")],-1)),B(N,{modelValue:n.cooldown,"onUpdate:modelValue":l[1]||(l[1]=e=>n.cooldown=e),modelModifiers:{number:!0},density:"compact","hide-details":"",style:{"max-width":"150px"},onInput:l[2]||(l[2]=e=>n.cooldown=e.replace(/[^0-9]/g,""))},null,8,["modelValue"])])])),_:1})])),_:1})])),_:1})])),_:1}),B(oe,{flat:"",class:"rounded mb-3 border config-card"},{default:R((()=>[B(te,{class:"px-3 py-2"},{default:R((()=>[B(ne,{modelValue:m.value,"onUpdate:modelValue":l[3]||(l[3]=e=>m.value=e),class:"mb-3",density:"compact","fixed-tabs":""},{default:R((()=>[B(ue,{value:"rules"},{default:R((()=>l[13]||(l[13]=[F("分发规则")]))),_:1}),B(ue,{value:"templates"},{default:R((()=>l[14]||(l[14]=[F("消息模板")]))),_:1})])),_:1},8,["modelValue"]),B(pe,{modelValue:m.value,"onUpdate:modelValue":l[4]||(l[4]=e=>m.value=e)},{default:R((()=>[B(me,{value:"rules"},{default:R((()=>[M("div",ee,[d.value&&d.value.length>0?(L(),G(ae,{key:0},{default:R((()=>[(L(!0),K(J,null,H(d.value,((e,l)=>(L(),G(g,{key:e.id,cols:"12",md:"6",lg:"4"},{default:R((()=>[B(x,{rule:e,index:l,"source-options":C.value,categories:U.value,rules:d.value,templates:k.value,onAlert:V,onSave:A,onDelete:j},null,8,["rule","index","source-options","categories","rules","templates"])])),_:2},1024)))),128))])),_:1})):(L(),G(ae,{key:1},{default:R((()=>[B(g,{cols:"12"},{default:R((()=>[B(u,{type:"info",variant:"tonal",icon:"mdi-information"},{default:R((()=>l[15]||(l[15]=[F(" 暂无分发规则，请点击下方按钮添加新规则 ")]))),_:1})])),_:1})])),_:1})),B(ce,null,{default:R((()=>[B(re,{onSubmit:Q((()=>{}),["prevent"])},{default:R((()=>[B(se,{density:"comfortable",class:"d-flex flex-wrap gap-4 mt-4"},{default:R((()=>[B(ie,{color:"success",variant:"tonal",onClick:S},{default:R((()=>[B(de,{icon:"mdi-plus"})])),_:1})])),_:1})])),_:1})])),_:1})])])),_:1}),B(me,{value:"templates"},{default:R((()=>[M("div",le,[i.value&&i.value.length>0?(L(),G(ae,{key:0},{default:R((()=>[(L(!0),K(J,null,H(i.value,((e,l)=>(L(),G(g,{key:e.id,cols:"12",md:"6",lg:"4"},{default:R((()=>[B(O,{template:e,index:l,templates:i.value,onAlert:V,onSave:I,onDelete:z},null,8,["template","index","templates"])])),_:2},1024)))),128))])),_:1})):(L(),G(ae,{key:1},{default:R((()=>[B(g,{cols:"12"},{default:R((()=>[B(u,{type:"info",variant:"tonal",icon:"mdi-information"},{default:R((()=>l[16]||(l[16]=[F(" 暂无消息模板，请点击下方按钮添加新模板 ")]))),_:1})])),_:1})])),_:1})),B(ce,null,{default:R((()=>[B(re,{onSubmit:Q((()=>{}),["prevent"])},{default:R((()=>[B(se,{density:"comfortable",class:"d-flex flex-wrap gap-4 mt-4"},{default:R((()=>[B(ie,{color:"success",variant:"tonal",onClick:E},{default:R((()=>[B(de,{icon:"mdi-plus"})])),_:1})])),_:1})])),_:1})])),_:1})])])),_:1})])),_:1},8,["modelValue"])])),_:1})])),_:1})])),_:1},8,["modelValue"])])),_:1}),B(ge,{modelValue:s.value,"onUpdate:modelValue":l[6]||(l[6]=e=>s.value=e),"max-width":"400"},{default:R((()=>[B(oe,null,{default:R((()=>[B(o,{class:"text-h6"},{default:R((()=>l[17]||(l[17]=[F("确认操作")]))),_:1}),B(te,null,{default:R((()=>[F(T(r.value),1)])),_:1}),B(_e,null,{default:R((()=>[B(fe),B(ye,{color:"grey",text:"",onClick:h},{default:R((()=>l[18]||(l[18]=[F("取消")]))),_:1}),B(ye,{color:"primary",onClick:w},{default:R((()=>l[19]||(l[19]=[F("确定")]))),_:1})])),_:1})])),_:1})])),_:1},8,["modelValue"]),B(be,{modelValue:b.show,"onUpdate:modelValue":l[8]||(l[8]=e=>b.show=e),color:b.color,timeout:b.timeout},{actions:R((()=>[B(ye,{variant:"text",onClick:l[7]||(l[7]=e=>b.show=!1)},{default:R((()=>l[20]||(l[20]=[F(" 关闭 ")]))),_:1})])),default:R((()=>[F(T(b.text)+" ",1)])),_:1},8,["modelValue","color","timeout"]),B(_e,{class:"px-2 py-1"},{default:R((()=>[B(fe),B(ye,{color:"secondary",variant:"text",onClick:$,"prepend-icon":"mdi-restore",size:"small"},{default:R((()=>l[21]||(l[21]=[F("恢复默认")]))),_:1}),B(ye,{color:"primary",disabled:!p.value||_.value,onClick:D,loading:_.value,"prepend-icon":"mdi-content-save",variant:"text",size:"small"},{default:R((()=>l[22]||(l[22]=[F("保存配置")]))),_:1},8,["disabled","loading"]),B(ye,{color:"grey",onClick:l[9]||(l[9]=e=>t("close")),"prepend-icon":"mdi-close",variant:"text",size:"small"},{default:R((()=>l[23]||(l[23]=[F("关闭")]))),_:1})])),_:1})])),_:1})])}}}),[["__scopeId","data-v-e8eb4736"]]);export{ne as default};
